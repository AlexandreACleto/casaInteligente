<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<title>Simulador ESP1 - Luz & Cortina</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin:16px; }
  .row { margin: 10px 0; }
  .ok { color: #2e7d32; font-weight: bold; }
  .bad { color: #c62828; font-weight: bold; }
  button { padding: 8px 12px; margin-right: 6px; }
  fieldset { margin-top: 14px; }
  code { background:#f0f0f0; padding: 2px 6px; border-radius: 4px; }
</style>
</head>
<body>
<h2>Simulador ESP1 — Luz & Cortina</h2>

<div class="row">
  Broker WS: <code id="url">ws://192.168.1.20:9001</code>
</div>
<div class="row">
  Conexão: <span id="conn" class="bad">Desconectado</span>
</div>
<div class="row">
  Último ping recebido: <span id="lastPing">—</span>
</div>

<fieldset>
  <legend>Publicar estados</legend>
  <div class="row">
    Luz:
    <button id="btnLightOn">on (retido)</button>
    <button id="btnLightOff">off (retido)</button>
  </div>
  <div class="row">
    Cortina:
    <button id="btnCurtainOpen">open (retido)</button>
    <button id="btnCurtainClose">close (retido)</button>
  </div>
</fieldset>

<fieldset>
  <legend>Sinal de vida (alive)</legend>
  <div class="row">
    <button id="btnAliveOnce">Enviar 1x</button>
    <button id="btnAliveStart">Iniciar a cada 20s</button>
    <button id="btnAliveStop">Parar</button>
  </div>
</fieldset>

<script>
  // ===== CONFIG =====
  const BROKER_URL = 'ws://192.168.1.20:9001'; // ajuste se usar /mqtt
  const CLIENT_ID = 'esp1_sim_' + Math.random().toString(16).slice(2);
  const TOPICS = {
    ping:     'home/ping',
    alive:    'home/status/esp1',
    light:    'home/light',
    curtain:  'home/curtain'
  };

  document.getElementById('url').textContent = BROKER_URL;

  // ===== MQTT =====
  const client = mqtt.connect(BROKER_URL, {
    clientId: CLIENT_ID,
    clean: true
  });

  const $conn     = document.getElementById('conn');
  const $lastPing = document.getElementById('lastPing');

  let hbTimer = null;

  client.on('connect', () => {
    $conn.textContent = 'Conectado';
    $conn.className = 'ok';
    client.subscribe(TOPICS.ping);
  });

  client.on('reconnect', () => {
    $conn.textContent = 'Reconectando...';
    $conn.className = 'bad';
  });

  client.on('close', () => {
    $conn.textContent = 'Desconectado';
    $conn.className = 'bad';
  });

  client.on('error', (err) => {
    console.error('MQTT error:', err);
  });

  client.on('message', (topic, payload) => {
    if (topic === TOPICS.ping) {
      $lastPing.textContent = new Date().toLocaleTimeString();
      // responde "alive" ao ping do painel
      client.publish(TOPICS.alive, 'alive');
    }
  });

  // ===== Ações =====
  document.getElementById('btnLightOn').onclick = () => {
    client.publish(TOPICS.light, 'on', { retain: true });
  };
  document.getElementById('btnLightOff').onclick = () => {
    client.publish(TOPICS.light, 'off', { retain: true });
  };
  document.getElementById('btnCurtainOpen').onclick = () => {
    client.publish(TOPICS.curtain, 'open', { retain: true });
  };
  document.getElementById('btnCurtainClose').onclick = () => {
    client.publish(TOPICS.curtain, 'close', { retain: true });
  };

  document.getElementById('btnAliveOnce').onclick = () => {
    client.publish(TOPICS.alive, 'alive');
  };
  document.getElementById('btnAliveStart').onclick = () => {
    if (hbTimer) return;
    hbTimer = setInterval(() => client.publish(TOPICS.alive, 'alive'), 500);
  };
  document.getElementById('btnAliveStop').onclick = () => {
    clearInterval(hbTimer);
    hbTimer = null;
  };
</script>
</body>
</html>
